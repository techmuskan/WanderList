<% layout("layouts/boilerplate") -%>

<style>
  /* Fade-in animation */
  .fade-in {
    animation: fadeIn 1s ease forwards;
    opacity: 0;
  }

  @keyframes fadeIn {
    to { opacity: 1; }
  }

  /* Left-align headers */
  .left-header {
    text-align: left;
    margin-bottom: 1rem;
  }

  /* Badge styling */
  .category-badge {
    font-size: 0.9rem;
  }
</style>

<div class="container my-4">

  <% if (!listing) { %>
    <!-- No Listing Found Placeholder -->
    <div class="fade-in d-flex flex-column justify-content-center align-items-center" style="height: 70vh; text-align: center; color: #555;">
      <i class="fa-solid fa-magnifying-glass" style="font-size: 5rem; margin-bottom: 1rem; color: #ff6b6b;"></i>
      <h2 class="fade-in">No listing found</h2>
      <p class="lead fade-in">Sorry, the listing you are looking for does not exist or has been removed.</p>
      <a href="/listings" class="btn btn-dark mt-3 fade-in">Back to Listings</a>
    </div>
  <% } else { %>

    <!-- Map Token & Coordinates -->
    <script>
      const mapToken = "<%= mapToken %>";
      const coordinates = JSON.parse('<%= JSON.stringify(listing.geometry?.coordinates || [77.4126, 23.2699]) %>');
      const place = "<%= listing.location || 'Unknown Location' %>";
    </script>
    <script src="/js/map.js" defer></script>

    <!-- Listing Title -->
    <div class="col-12 col-md-8 offset-md-2 fade-in">
      <h2><b><%= listing.title || "Untitled Listing" %></b></h2>
    </div>

    <!-- Listing Card -->
    <div class="card offset-2 mb-4 listing-card fade-in" style="max-width: 900px;">
      <% 
        const imgURL = listing.image?.url
          ? listing.image.url.includes('upload') 
            ? listing.image.url.replace('/upload', '/upload/w_800,h_500,c_fill') 
            : listing.image.url
          : '/images/default.jpg';
      %>
      <img src="<%= imgURL %>" alt="Listing Image" class="card-img-top">

      <div class="card-body">
        <p><i>Owned by <%= listing.owner?.username || "Anonymous" %></i></p>
        <p><%= listing.description || "No description provided." %></p>
        <p><strong>Price:</strong> &#8377;<%= listing.price ? listing.price.toLocaleString("en-IN") : "0" %></p>
        <p><strong>Location:</strong> <%= listing.location || "Not specified" %></p>
        <p><strong>Country:</strong> <%= listing.country || "Not specified" %></p>
        <p><strong>Category:</strong> <span class="badge bg-secondary category-badge"><%= listing.category || "Uncategorized" %></span></p>

        <!-- Owner Buttons -->
        <% if(currentUser && listing.owner?._id?.toString() === currentUser._id?.toString()) { %>
        <div class="d-flex justify-content-start flex-wrap gap-2 my-3">
          <form action="/listings/<%= listing._id %>/edit" method="get">
            <button class="btn btn-dark px-4">Update</button>
          </form>
          <form action="/listings/<%= listing._id %>?_method=DELETE" method="post">
            <button class="btn btn-dark px-4">Delete</button>
          </form>
        </div>
        <% } %>

        <hr>
<!-- Review Form (always visible) -->
<div class="mb-4 fade-in">
  <h4>Leave a Review</h4>

  <% if(currentUser) { %>
    <!-- Logged-in users: active form -->
    <form method="POST" action="/listings/<%= listing._id %>/reviews" novalidate class="needs-validation">
      <label class="form-label">Rating</label>
      <fieldset class="starability-slot mb-3">
        <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
        <input type="radio" id="rate1" name="review[rating]" value="1" /><label for="rate1" title="Terrible">1 star</label>
        <input type="radio" id="rate2" name="review[rating]" value="2" /><label for="rate2" title="Not good">2 stars</label>
        <input type="radio" id="rate3" name="review[rating]" value="3" /><label for="rate3" title="Average">3 stars</label>
        <input type="radio" id="rate4" name="review[rating]" value="4" /><label for="rate4" title="Very good">4 stars</label>
        <input type="radio" id="rate5" name="review[rating]" value="5" /><label for="rate5" title="Amazing">5 stars</label>
      </fieldset>

      <div class="mb-3">
        <label for="comment" class="form-label">Comment</label>
        <textarea required name="review[comment]" id="comment" rows="4" class="form-control"></textarea>
        <div class="invalid-feedback">Please enter a comment.</div>
      </div>
      <button class="btn btn-outline-dark">Submit</button>
    </form>
  <% } else { %>
    <!-- Not logged-in users: disabled form with message -->
    <form class="needs-validation" novalidate>
      <label class="form-label">Rating</label>
      <fieldset class="starability-slot mb-3" disabled>
        <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
        <input type="radio" id="rate1" name="review[rating]" value="1" /><label for="rate1" title="Terrible">1 star</label>
        <input type="radio" id="rate2" name="review[rating]" value="2" /><label for="rate2" title="Not good">2 stars</label>
        <input type="radio" id="rate3" name="review[rating]" value="3" /><label for="rate3" title="Average">3 stars</label>
        <input type="radio" id="rate4" name="review[rating]" value="4" /><label for="rate4" title="Very good">4 stars</label>
        <input type="radio" id="rate5" name="review[rating]" value="5" /><label for="rate5" title="Amazing">5 stars</label>
      </fieldset>

      <div class="mb-3">
        <label for="comment" class="form-label">Comment</label>
        <textarea id="comment" rows="4" class="form-control" placeholder="Login to submit a review" disabled></textarea>
      </div>
      <button class="btn btn-outline-dark" disabled>Submit</button>
      <p class="text-muted mt-2">Please <a href="/login">login</a> to submit a review.</p>
    </form>
  <% } %>
</div>


        <!-- Reviews List -->
        <h4 class="left-header fade-in">All Reviews</h4>
        <% const reviews = (listing.reviews || []).slice().reverse(); %>
        <% if(reviews.length === 0) { %>
        <div class="text-center my-3 fade-in">
          <p class="lead">No reviews yet. Be the first to review!</p>
        </div>
        <% } else { %>
        <div class="row justify-content-start flex-wrap fade-in">
          <% reviews.forEach(review => { %>
          <div class="card col-12 col-md-5 mb-3 mx-2">
            <div class="card-body">
              <h5 class="card-title"><%= review.author?.username || "Anonymous" %></h5>
              <p class="starability-result" data-rating="<%= review.rating %>">Rated:</p>
              <p class="card-text"><%= review.comment || "No comment provided." %></p>
            </div>
            <% if(currentUser && review.author?._id?.toString() === currentUser._id?.toString()) { %>
            <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="text-start mb-2">
              <button class="btn btn-dark btn-sm">Delete Review</button>
            </form>
            <% } %>
          </div>
          <% }) %>
        </div>
        <% } %>

      </div>

      <!-- Map Section -->
      <div class="col-12 col-md-8 offset-md-2 fade-in">
  <h3>Where you'll be</h3>
  <div id="map" style="width: 100%; height: 400px; margin-bottom: 40px; border-radius: 8px;"></div>
</div>


  <% } %>
</div>
