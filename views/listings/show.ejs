<% layout("layouts/boilerplate") -%>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/starability/2.4.2/starability-all.min.css">

<style>
  /* Fade-in animation */
  .fade-in {
    animation: fadeIn 1s ease forwards;
    opacity: 0;
  }

  @keyframes fadeIn { to { opacity: 1; } }

  /* Left-align headers */
  .left-header { text-align: left; margin-bottom: 1rem; }

  /* Badge styling */
  .category-badge { font-size: 0.9rem; }
</style>

<div class="container my-4">

  <% if (!listing) { %>
    <!-- No Listing Found -->
    <div class="fade-in d-flex flex-column justify-content-center align-items-center" style="height: 70vh; text-align: center; color: #555;">
      <i class="fa-solid fa-magnifying-glass" style="font-size:5rem; margin-bottom:1rem; color:#ff6b6b;"></i>
      <h2 class="fade-in">No listing found</h2>
      <p class="lead fade-in">Sorry, the listing you are looking for does not exist or has been removed.</p>
      <a href="/listings" class="btn btn-dark mt-3 fade-in">Back to Listings</a>
    </div>
  <% } else { %>

    <!-- Map Script Variables -->
    <script>
      const mapToken = "<%= mapToken %>";
      const coordinates = JSON.parse('<%= JSON.stringify(listing.geometry?.coordinates || [77.4126,23.2699]) %>');
      const place = "<%= listing.location || 'Unknown Location' %>";
    </script>
    <script src="/js/map.js" defer></script>

    <!-- Listing Title -->
    <div class="fade-in text-center my-4">
      <h2><b><%= listing.title || "Untitled Listing" %></b></h2>
    </div>

    <!-- Listing Card -->
    <div class="card mx-auto mb-4 listing-card fade-in" style="max-width:900px;">
      <% const imgURL = listing.image?.url
        ? listing.image.url.includes('upload')
          ? listing.image.url.replace('/upload','/upload/w_800,h_500,c_fill')
          : listing.image.url
        : '/images/default.jpg';
      %>
      <img src="<%= imgURL %>" alt="Listing Image" class="card-img-top">
      <div class="card-body">
        <p><i>Owned by <%= listing.owner?.username || "Anonymous" %></i></p>
        <p><%= listing.description || "No description provided." %></p>
        <p><strong>Price:</strong> &#8377;<%= listing.price?.toLocaleString("en-IN") || "0" %></p>
        <p><strong>Location:</strong> <%= listing.location || "Not specified" %></p>
        <p><strong>Country:</strong> <%= listing.country || "Not specified" %></p>
        <p><strong>Category:</strong> <span class="badge bg-secondary category-badge"><%= listing.category || "Uncategorized" %></span></p>

        <!-- Owner Buttons -->
        <% if(currentUser && listing.owner?._id?.toString() === currentUser._id?.toString()) { %>
          <div class="d-flex justify-content-start flex-wrap gap-2 my-3">
            <form action="/listings/<%= listing._id %>/edit" method="get">
              <button class="btn btn-dark px-4">Update</button>
            </form>
            <form action="/listings/<%= listing._id %>?_method=DELETE" method="post">
              <button class="btn btn-dark px-4">Delete</button>
            </form>
          </div>
        <% } %>

        <hr>

        <!-- Review Form -->
        <% if(currentUser) { %>
          <h4 class="left-header fade-in">Leave a Review</h4>
          <form method="POST" action="/listings/<%= listing._id %>/reviews" novalidate class="needs-validation">
            
            <!-- Starability Slot -->
            <fieldset class="starability-slot mb-3" aria-label="Star rating">
              <h5>Rate this listing:</h5>
              <input type="radio" id="no-rate-<%= listing._id %>" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating" />
              <% for(let i=1;i<=5;i++){ %>
                <input type="radio" id="rate<%= i %>-<%= listing._id %>" name="review[rating]" value="<%= i %>" />
                <label for="rate<%= i %>-<%= listing._id %>" title="<%= ['Terrible','Not good','Average','Very good','Amazing'][i-1] %>"><%= i %> star</label>
              <% } %>
            </fieldset>

            <!-- Comment -->
            <div class="mb-3">
              <label for="review-comment-<%= listing._id %>" class="form-label">Your Review</label>
              <textarea class="form-control" id="review-comment-<%= listing._id %>" name="review[comment]" rows="3" required></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Submit Review</button>
          </form>
        <% } else { %>
          <p>Please <a href="/login">login</a> to leave a review.</p>
        <% } %>

        <hr>

        <!-- Reviews List -->
        <h4 class="left-header fade-in">All Reviews</h4>
        <% const reviews = (listing.reviews || []).slice().reverse(); %>
        <% if(reviews.length === 0) { %>
          <div class="text-center my-3 fade-in">
            <p class="lead">No reviews yet. Be the first to review!</p>
          </div>
        <% } else { %>
          <div class="row justify-content-start flex-wrap fade-in">
            <% reviews.forEach(review => { %>
              <div class="card col-12 col-md-5 mb-3 mx-2">
                <div class="card-body">
                  <h5 class="card-title"><%= review.author?.username || "Anonymous" %></h5>
                  <p class="starability-result" data-rating="<%= review.rating %>">Rated:</p>
                  <p class="card-text"><%= review.comment || "No comment provided." %></p>
                </div>
                <% if(currentUser && review.author?._id?.toString() === currentUser._id?.toString()) { %>
                  <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="text-start mb-2">
                    <button class="btn btn-dark btn-sm">Delete Review</button>
                  </form>
                <% } %>
              </div>
            <% }) %>
          </div>
        <% } %>

      </div>
    </div>

    <!-- Map Section -->
    <div class="fade-in d-flex justify-content-center mb-4">
      <div id="map" style="width: 100%; max-width: 900px; height: 400px; border-radius: 8px;"></div>
    </div>

  <% } %>
</div>
